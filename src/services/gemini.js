import { GoogleGenerativeAI } from '@google/generative-ai';

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Gemini Flash API
 */
class GeminiService {
    constructor(apiKey) {
        this.genAI = new GoogleGenerativeAI(apiKey);
        this.model = this.genAI.getGenerativeModel({
            model: 'gemini-2.5-flash',
            generationConfig: {
                temperature: 0.7,
                maxOutputTokens: 1500, // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è thinking mode
            }
        });
    }

    /**
     * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥ –ø—Ä–∞–∫—Ç–∏–∫–∏ HEAL
     * @param {string} step - –®–∞–≥ HEAL: 'H', 'E', 'A', 'L'
     * @param {string} userText - –¢–µ–∫—Å—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * @param {Object} previousContext - –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤
     * @returns {Promise<string>} - –ê–Ω–∞–ª–∏–∑ –æ—Ç Gemini
     */
    async analyzeHealStep(step, userText, previousContext = {}) {
        const stepNames = {
            H: 'Having (–û—Å–æ–∑–Ω–∞–π –æ–ø—ã—Ç)',
            E: 'Enriching (–û–±–æ–≥–∞—Ç–∏ –æ—â—É—â–µ–Ω–∏–µ)',
            A: 'Absorbing (–í–ø–∏—Ç–∞–π –≤ —Å–µ–±—è)',
            L: 'Linking (–°–æ–∑–¥–∞–π —Å–≤—è–∑—å)'
        };

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤
        let contextText = '';
        const stepOrder = ['H', 'E', 'A', 'L'];
        const currentStepIndex = stepOrder.indexOf(step);

        for (let i = 0; i < currentStepIndex; i++) {
            const prevStep = stepOrder[i];
            if (previousContext[prevStep]) {
                contextText += `\\n–®–∞–≥ ${prevStep}: ${previousContext[prevStep].userText}\\n`;
            }
        }

        const stepPrompts = {
            H: `–®–∞–≥ H (Having) - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å–∞–ª —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
"${userText}"

–í–ê–®–ê –ó–ê–î–ê–ß–ê: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤ –∫–∞–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –¥–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ—Ç–≤–µ—Ç.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–°–¶–ï–ù–ê–†–ò–ô 1: –û–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –û–ö
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç, —á—Ç–æ –ò –≤ —Ç–µ–ª–µ, –ò –≤ –º—ã—Å–ª—è—Ö/—ç–º–æ—Ü–∏—è—Ö –≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ, —Å–ø–æ–∫–æ–π–Ω–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–µ—Ç —Ç—Ä–µ–≤–æ–≥–∏:

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–°–¢–ê–¢–£–°:OK
[–ö–æ—Ä–æ—Ç–∫–æ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]

–ü—Ä–∏–º–µ—Ä:
–°–¢–ê–¢–£–°:OK
–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ, —á—Ç–æ –≤—ã –∑–∞–º–µ—á–∞–µ—Ç–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ –≤ —Ç–µ–ª–µ, –∏ –≤ –º—ã—Å–ª—è—Ö. –≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –æ—Å–Ω–æ–≤–∞ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–°–¶–ï–ù–ê–†–ò–ô 2: –û–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –ù–ï –û–ö
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –±–æ–ª—å, –ø–∞–Ω–∏–∫—É, —Å–∏–ª—å–Ω—É—é —Ç—Ä–µ–≤–æ–≥—É, –∫—Ä–∏–∑–∏—Å, –ø–ª–æ—Ö–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ:

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–°–¢–ê–¢–£–°:NOT_OK
–Ø —Å–ª—ã—à—É, —á—Ç–æ —Å–µ–π—á–∞—Å –≤–∞–º –Ω–µ–ø—Ä–æ—Å—Ç–æ. üíô

–í–∞–∂–Ω–æ –ø–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–µ–±–µ:
‚Ä¢ –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Å—Ä–æ—á–Ω–∞—è –ø–æ–º–æ—â—å: –¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è 8-800-2000-122 (24/7, –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
‚Ä¢ –ï—Å–ª–∏ –µ—Å—Ç—å –±–æ–ª—å –∏–ª–∏ –Ω–µ–¥–æ–º–æ–≥–∞–Ω–∏–µ - –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É
‚Ä¢ –°–¥–µ–ª–∞–π—Ç–µ —á—Ç–æ-—Ç–æ –º–∞–ª–µ–Ω—å–∫–æ–µ –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–∞: –≤—ã–ø–µ–π—Ç–µ –≤–æ–¥—ã, –æ—Ç–¥–æ—Ö–Ω–∏—Ç–µ, –≤—ã–π–¥–∏—Ç–µ –Ω–∞ –≤–æ–∑–¥—É—Ö

–ü—Ä–∞–∫—Ç–∏–∫–∞ –û–ö-–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ, –∫–æ–≥–¥–∞ –±–∞–∑–æ–≤—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω—ã. –ü–æ–∑–∞–±–æ—Ç—å—Ç–µ—Å—å –æ —Å–µ–±–µ. ü§ç

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–°–¶–ï–ù–ê–†–ò–ô 3: –°–º–µ—à–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û:
- –í —Ç–µ–ª–µ –û–ö (–¥—ã—Ö–∞–Ω–∏–µ —Å–ø–æ–∫–æ–π–Ω–æ–µ, –ø—É–ª—å—Å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
- –ù–û –≤ –º—ã—Å–ª—è—Ö/—ç–º–æ—Ü–∏—è—Ö —Ç—Ä–µ–≤–æ–≥–∞, —Å–æ–º–Ω–µ–Ω–∏—è, –±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ, –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–°–¢–ê–¢–£–°:MIXED
–í—ã –∑–∞–º–µ—Ç–∏–ª–∏ –≤–∞–∂–Ω–æ–µ: —Ç–µ–ª–æ —Å–ø–æ–∫–æ–π–Ω–æ, –Ω–æ –≤ –≥–æ–ª–æ–≤–µ [—É–ø–æ–º—è–Ω—É—Ç—å —á—Ç–æ: —Ç—Ä–µ–≤–æ–∂–Ω—ã–µ –º—ã—Å–ª–∏/—Å–æ–º–Ω–µ–Ω–∏—è/–±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ]. –≠—Ç–æ —Å–º–µ—à–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - —Ç–µ–ª—É –û–ö, –Ω–æ —É–º –∑–∞–Ω—è—Ç –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è–º–∏.

–°–µ–π—á–∞—Å —É –≤–∞—Å –µ—Å—Ç—å –≤—ã–±–æ—Ä:
‚Ä¢ –ú–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å—Å—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É - –∏–Ω–æ–≥–¥–∞ —Ç–µ–ª–æ –¥–∞—ë—Ç –æ–ø–æ—Ä—É, —á—Ç–æ–±—ã —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å —Ç—Ä–µ–≤–æ–≥–æ–π
‚Ä¢ –ú–æ–∂–Ω–æ –ø–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–µ–±–µ –∏ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å - –¥–∞—Ç—å —É–º—É –≤—Ä–µ–º—è —É—Å–ø–æ–∫–æ–∏—Ç—å—Å—è

–û–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã. –í–∞–∂–Ω–æ —á–µ—Å—Ç–Ω–æ –ø–æ–Ω—è—Ç—å: –≥–æ—Ç–æ–≤—ã –ª–∏ –≤—ã —Å–µ–π—á–∞—Å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–ª–∏ –ª—É—á—à–µ –ø–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–µ–±–µ?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–í–ê–ñ–ù–û:
- –í–°–ï–ì–î–ê –Ω–∞—á–∏–Ω–∞–π—Ç–µ –æ—Ç–≤–µ—Ç —Å "–°–¢–ê–¢–£–°:OK", "–°–¢–ê–¢–£–°:NOT_OK" –∏–ª–∏ "–°–¢–ê–¢–£–°:MIXED"
- –û–ë–†–ê–©–ê–ô–¢–ï–°–¨ –ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ù–ê "–í–´"
- –ë—É–¥—å—Ç–µ —Ç—ë–ø–ª—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º`,

            E: `–®–∞–≥ E (Enriching) - –ø–æ–º–æ–≥–∏—Ç–µ —É–≥–ª—É–±–∏—Ç—å –∏ –æ–±–æ–≥–∞—Ç–∏—Ç—å –æ–ø—ã—Ç –û–ö-–Ω–æ—Å—Ç–∏.

–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞:${contextText}

–°–µ–π—á–∞—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å–∞–ª:
"${userText}"

–í–∞—à–∞ –∑–∞–¥–∞—á–∞:
–û—Ç–º–µ—Ç—å—Ç–µ –¥–µ—Ç–∞–ª–∏ –∏ –Ω—é–∞–Ω—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–º–µ—Ç–∏–ª –ø—Ä–∏ –æ–±–æ–≥–∞—â–µ–Ω–∏–∏ –æ–ø—ã—Ç–∞.
–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ —É–≥–ª—É–±–ª–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è –∫ –ø—Ä–∏—è—Ç–Ω—ã–º –æ—â—É—â–µ–Ω–∏—è–º.
1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ç—ë–ø–ª—ã–π —Ç–æ–Ω.
–û–ë–†–ê–©–ê–ô–¢–ï–°–¨ –ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ù–ê "–í–´".`,

            A: `–®–∞–≥ A (Absorbing) - –ø–æ–º–æ–≥–∏—Ç–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø—ã—Ç –û–ö-–Ω–æ—Å—Ç–∏.

–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤:${contextText}

–°–µ–π—á–∞—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å–∞–ª:
"${userText}"

–í–∞—à–∞ –∑–∞–¥–∞—á–∞:
–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –≤–ø–∏—Ç—ã–≤–∞–Ω–∏—è –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
–û—Ç–º–µ—Ç—å—Ç–µ –≤–∞–∂–Ω–æ—Å—Ç—å —Ç–æ–≥–æ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–µ–±–µ –ø—Ä–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —ç—Ç–æ.
1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∑–∞–∑–µ–º–ª—è—é—â–∏–π —Ç–æ–Ω.
–û–ë–†–ê–©–ê–ô–¢–ï–°–¨ –ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ù–ê "–í–´".`,

            L: `–®–∞–≥ L (Linking) - –ø–æ–º–æ–≥–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å —Å —Ä–µ—Å—É—Ä—Å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º.

–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∞–∫—Ç–∏–∫–∏:${contextText}

–°–µ–π—á–∞—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å–∞–ª:
"${userText}"

–í–∞—à–∞ –∑–∞–¥–∞—á–∞:
–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∏ —ç—Ç–æ–≥–æ –æ–ø—ã—Ç–∞ –û–ö-–Ω–æ—Å—Ç–∏ —Å –±—É–¥—É—â–∏–º–∏ —Å–∏—Ç—É–∞—Ü–∏—è–º–∏.
–û—Ç–º–µ—Ç—å—Ç–µ –≤–∞–∂–Ω–æ—Å—Ç—å —Ç–æ–≥–æ, —á—Ç–æ —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ –∫–∞–∫ —Ä–µ—Å—É—Ä—Å.
1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –≤–æ–æ–¥—É—à–µ–≤–ª—è—é—â–∏–π —Ç–æ–Ω.
–û–ë–†–ê–©–ê–ô–¢–ï–°–¨ –ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ù–ê "–í–´".`
        };

        const prompt = stepPrompts[step] + `\n\n–í–ê–ñ–ù–û:\n- –≠—Ç–æ –ù–ï —Ç–µ—Ä–∞–ø–∏—è, –∞ –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å–∞–º–æ–ø–æ–º–æ—â–∏\n- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã\n- –û–ë–†–ê–©–ê–ô–¢–ï–°–¨ –ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ù–ê \"–í–´\"\n- –û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ\n- –ú–∞–∫—Å–∏–º—É–º 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è\n\n–û—Ç–≤–µ—Ç:`;

        const maxRetries = 2;

        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                console.log(`üì§ HEAL Step ${step}: –ø–æ–ø—ã—Ç–∫–∞ ${attempt}/${maxRetries}`);
                const result = await this.model.generateContent(prompt);
                const response = await result.response;

                console.log('üìã Response details:', {
                    candidates: response.candidates?.length || 0,
                    finishReason: response.candidates?.[0]?.finishReason
                });

                if (!response.candidates || response.candidates.length === 0) {
                    if (attempt < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        continue;
                    }
                    return '';
                }

                const text = response.text();
                console.log(`‚úÖ HEAL Step ${step} analysis complete`);

                if ((!text || text.trim().length === 0) && attempt < maxRetries) {
                    console.warn(`‚ö†Ô∏è  –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ —à–∞–≥–µ ${step}`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    continue;
                }

                return text.trim();
            } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —à–∞–≥–µ ${step}:`, error.message);
                if (attempt === maxRetries) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        return '';
    }

    /**
     * –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç–µ–∫—É—â–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ HEAL
     */
    async answerHealQuestion(step, question, sessionContext) {
        const stepNames = {
            H: 'Having (–û—Å–æ–∑–Ω–∞–Ω–∏–µ –æ–ø—ã—Ç–∞)',
            E: 'Enriching (–û–±–æ–≥–∞—â–µ–Ω–∏–µ)',
            A: 'Absorbing (–í–ø–∏—Ç—ã–≤–∞–Ω–∏–µ)',
            L: 'Linking (–°–≤—è–∑—ã–≤–∞–Ω–∏–µ)'
        };

        let contextText = '';
        for (const [s, data] of Object.entries(sessionContext)) {
            if (data.userText) {
                contextText += `\\n–®–∞–≥ ${s}: ${data.userText}\\n`;
            }
        }

        const prompt = `–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –ø—Ä–∞–∫—Ç–∏–∫–µ HEAL (–æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ–∫–æ–π).

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–µ–π—á–∞—Å –Ω–∞ —à–∞–≥–µ ${step} (${stepNames[step]}).

–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∞–∫—Ç–∏–∫–∏:${contextText}

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å:
"${question}"

–í–∞—à–∞ –∑–∞–¥–∞—á–∞:
–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å —Ç–µ–ø–ª–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É, –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞ –ø—Ä–∞–∫—Ç–∏–∫–∏.
–ü–æ–º–æ–≥–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É, –Ω–µ —É–≤–æ–¥—è –≤ —Å—Ç–æ—Ä–æ–Ω—É.
2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º.
–û–ë–†–ê–©–ê–ô–¢–ï–°–¨ –ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ù–ê "–í–´".

–í–ê–ñ–ù–û:
- –≠—Ç–æ –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å–∞–º–æ–ø–æ–º–æ—â–∏, –Ω–µ —Ç–µ—Ä–∞–ø–∏—è
- –ë—É–¥—å—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º
- –û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

–û—Ç–≤–µ—Ç:`;

        try {
            console.log(`üí¨ –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –Ω–∞ —à–∞–≥–µ ${step}`);
            const result = await this.model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();

            return text.trim();
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å:', error.message);
            return '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ–ø—Ä–æ—Å. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏–º –ø—Ä–∞–∫—Ç–∏–∫—É? ü§ç';
        }
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ HEAL
     */
    async generateFinalSummary(fullHistory) {
        let historyText = '';
        const steps = ['H', 'E', 'A', 'L'];

        for (const step of steps) {
            if (fullHistory[step]?.userText) {
                historyText += `\\n–®–∞–≥ ${step}: ${fullHistory[step].userText}\\n`;
            }
        }

        const prompt = `–°–æ–∑–¥–∞–π –∏—Ç–æ–≥–æ–≤–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ HEAL.

–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:${historyText}

–í–∞—à–∞ –∑–∞–¥–∞—á–∞:
–û—Ç—Ä–∞–∑–∏—Ç–µ –ø—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –≤—Å–µ 4 —à–∞–≥–∞: H (–æ—Å–æ–∑–Ω–∞–Ω–∏–µ) ‚Üí E (–æ–±–æ–≥–∞—â–µ–Ω–∏–µ) ‚Üí A (–≤–ø–∏—Ç—ã–≤–∞–Ω–∏–µ) ‚Üí L (—Å–≤—è–∑—å).
–ü–æ–¥—á–µ—Ä–∫–Ω–∏—Ç–µ —Ü–µ–Ω–Ω–æ—Å—Ç—å —ç—Ç–æ–≥–æ –æ–ø—ã—Ç–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —ç—Ç–æ–≥–æ —Ä–µ—Å—É—Ä—Å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ç—ë–ø–ª—ã–π –∏ –≤–æ–æ–¥—É—à–µ–≤–ª—è—é—â–∏–π —Ç–æ–Ω.
–û–ë–†–ê–©–ê–ô–¢–ï–°–¨ –ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ù–ê "–í–´".

–í–ê–ñ–ù–û:
- –≠—Ç–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏
- –ë—É–¥—å—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º
- –û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

–û—Ç–≤–µ—Ç:`;

        try {
            console.log('üéä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ summary');
            const result = await this.model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();

            return text.trim();
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ summary:', error.message);
            return '–ü—Ä–µ–∫—Ä–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—ã –ø—Ä–æ—à–ª–∏ —á–µ—Ä–µ–∑ –≤—Å–µ 4 —à–∞–≥–∞ –ø—Ä–∞–∫—Ç–∏–∫–∏ HEAL –∏ —Å–æ–∑–¥–∞–ª–∏ –¥–ª—è —Å–µ–±—è —Ä–µ—Å—É—Ä—Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–æ–∫–æ—è. üåü';
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ API —Å —Ç–∞–π–º–∞—É—Ç–æ–º
     */
    async healthCheck() {
        try {
            console.log('–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ Gemini API...');

            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Timeout')), 10000)
            );

            const checkPromise = this.model.generateContent('Test');

            await Promise.race([checkPromise, timeoutPromise]);

            console.log('‚úÖ Gemini API –æ—Ç–≤–µ—á–∞–µ—Ç');
            return true;
        } catch (error) {
            console.error('‚ö†Ô∏è  Gemini API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error.message);
            if (error.status) {
                console.error('HTTP —Å—Ç–∞—Ç—É—Å:', error.status);
            }
            return false;
        }
    }
}

export default GeminiService;
