import { Telegraf } from 'telegraf';
import express from 'express';
import dotenv from 'dotenv';
import GeminiService from './services/gemini.js';

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config();

const BOT_TOKEN = process.env.BOT_TOKEN;
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

if (!BOT_TOKEN || !GEMINI_API_KEY) {
    console.error('‚ùå –û—à–∏–±–∫–∞: BOT_TOKEN –∏ GEMINI_API_KEY –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–∫–∞–∑–∞–Ω—ã –≤ .env —Ñ–∞–π–ª–µ');
    process.exit(1);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤
const bot = new Telegraf(BOT_TOKEN);
const gemini = new GeminiService(GEMINI_API_KEY);

// Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
bot.use(async (ctx, next) => {
    console.log('üì® –í—Ö–æ–¥—è—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:', {
        update_id: ctx.update.update_id,
        message: ctx.message ? {
            from: ctx.from.username,
            text: ctx.message.text
        } : '–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è',
        type: ctx.updateType
    });
    return next();
});

// –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤ –ø–∞–º—è—Ç–∏ –¥–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞)
const userStates = new Map();

// ==================== –ö–û–ú–ê–ù–î–´ ====================

/**
 * –ö–æ–º–∞–Ω–¥–∞ /start - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
 */
bot.command('start', async (ctx) => {
    const firstName = ctx.from.first_name || '–¥—Ä—É–≥';

    await ctx.reply(
        `–ü—Ä–∏–≤–µ—Ç, ${firstName}! üëã\n\n` +
        `–Ø HEAL Wellness –ë–æ—Ç - –ø–æ–º–æ–≥–∞—é –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–∞–∫—Ç–∏–∫—É –û–ö-–Ω–æ—Å—Ç–∏.\n\n` +
        `üí° –≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∞–º–æ–ø–æ–º–æ—â–∏, –Ω–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å.\n\n` +
        `–ö–æ–º–∞–Ω–¥—ã:\n` +
        `/practice - –ù–∞—á–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É –û–ö-–Ω–æ—Å—Ç–∏\n` +
        `/help - –°–ø—Ä–∞–≤–∫–∞\n\n` +
        `–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å? –ù–∞–∂–º–∏ /practice`,
        {
            reply_markup: {
                keyboard: [
                    [{ text: '‚úÖ –ü—Ä–∞–∫—Ç–∏–∫–∞ –û–ö-–Ω–æ—Å—Ç–∏' }],
                    [{ text: '‚ùì –ü–æ–º–æ—â—å' }]
                ],
                resize_keyboard: true
            }
        }
    );
});

/**
 * –ö–æ–º–∞–Ω–¥–∞ /help - –°–ø—Ä–∞–≤–∫–∞
 */
bot.command('help', async (ctx) => {
    await ctx.reply(
        `üìñ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:\n\n` +
        `1. –ù–∞–∂–º–∏ /practice –∏–ª–∏ –∫–Ω–æ–ø–∫—É "‚úÖ –ü—Ä–∞–∫—Ç–∏–∫–∞ –û–ö-–Ω–æ—Å—Ç–∏"\n` +
        `2. –ù–∞—Å—Ç—Ä–æ–π—Å—è –Ω–∞ —Å–≤–æ–µ —Ç–µ–ª–æ –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å\n` +
        `3. –û–ø–∏—à–∏ —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç —Ç–µ–±–µ, —á—Ç–æ —Å–µ–π—á–∞—Å —Å —Ç–æ–±–æ–π –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ\n` +
        `4. –ü–æ–ª—É—á–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç AI\n\n` +
        `üí° –≠—Ç–æ –Ω–µ —Ç–µ—Ä–∞–ø–∏—è, –∞ –ø—Ä–∞–∫—Ç–∏–∫–∞ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–æ–∫–æ—è.\n` +
        `–î–ª—è —Å–µ—Ä—å—ë–∑–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –æ–±—Ä–∞—Ç–∏—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.\n\n` +
        `üìû –ö—Ä–∏–∑–∏—Å–Ω–∞—è –ø–æ–º–æ—â—å:\n` +
        `–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è: 8-800-2000-122 (24/7, –±–µ—Å–ø–ª–∞—Ç–Ω–æ)`
    );
});

/**
 * –ö–æ–º–∞–Ω–¥–∞ /practice - –ù–∞—á–∞–ª–æ –ø—Ä–∞–∫—Ç–∏–∫–∏
 */
bot.command('practice', async (ctx) => {
    const userId = ctx.from.id;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
    userStates.set(userId, { state: 'awaiting_okness' });

    await ctx.reply(
        `‚ú® –ü—Ä–∞–∫—Ç–∏–∫–∞ –û–ö-–Ω–æ—Å—Ç–∏\n\n` +
        `–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –Ω–∞—Å—Ç—Ä–æ–π—Å—è –Ω–∞ —Å–≤–æ–µ —Ç–µ–ª–æ –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ.\n\n` +
        `–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ:\n` +
        `‚Ä¢ –ö–∞–∫ —Ç—ã –¥—ã—à–∏—à—å - –≤–æ–∑–¥—É—Ö–∞ —Ö–≤–∞—Ç–∞–µ—Ç\n` +
        `‚Ä¢ –ü—É–ª—å—Å —Å—Ç–∞–±–∏–ª–µ–Ω, —Å–µ—Ä–¥—Ü–µ —Ä–∞–±–æ—Ç–∞–µ—Ç\n` +
        `‚Ä¢ –¢–≤–æ–µ —Ç–µ–ª–æ –∂–∏–≤–æ–µ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç\n` +
        `‚Ä¢ –í–æ–∫—Ä—É–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–∏–∫—Ç–æ –Ω–µ —É–≥—Ä–æ–∂–∞–µ—Ç\n\n` +
        `–û–ø–∏—à–∏, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å. –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç —Ç–µ–±–µ –æ —Ç–æ–º, —á—Ç–æ —Å–µ–π—á–∞—Å —Å —Ç–æ–±–æ–π –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ? üëá`,
        {
            reply_markup: {
                keyboard: [
                    [{ text: '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å' }]
                ],
                resize_keyboard: true
            }
        }
    );
});

// ==================== –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö ====================

bot.hears('‚úÖ –ü—Ä–∞–∫—Ç–∏–∫–∞ –û–ö-–Ω–æ—Å—Ç–∏', async (ctx) => {
    const userId = ctx.from.id;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
    userStates.set(userId, { state: 'awaiting_okness' });

    await ctx.reply(
        `‚ú® –ü—Ä–∞–∫—Ç–∏–∫–∞ –û–ö-–Ω–æ—Å—Ç–∏\n\n` +
        `–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –Ω–∞—Å—Ç—Ä–æ–π—Å—è –Ω–∞ —Å–≤–æ–µ —Ç–µ–ª–æ –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ.\n\n` +
        `–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ:\n` +
        `‚Ä¢ –ö–∞–∫ —Ç—ã –¥—ã—à–∏—à—å - –≤–æ–∑–¥—É—Ö–∞ —Ö–≤–∞—Ç–∞–µ—Ç\n` +
        `‚Ä¢ –ü—É–ª—å—Å —Å—Ç–∞–±–∏–ª–µ–Ω, —Å–µ—Ä–¥—Ü–µ —Ä–∞–±–æ—Ç–∞–µ—Ç\n` +
        `‚Ä¢ –¢–≤–æ–µ —Ç–µ–ª–æ –∂–∏–≤–æ–µ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç\n` +
        `‚Ä¢ –í–æ–∫—Ä—É–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–∏–∫—Ç–æ –Ω–µ —É–≥—Ä–æ–∂–∞–µ—Ç\n\n` +
        `–û–ø–∏—à–∏, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å. –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç —Ç–µ–±–µ –æ —Ç–æ–º, —á—Ç–æ —Å–µ–π—á–∞—Å —Å —Ç–æ–±–æ–π –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ? üëá`,
        {
            reply_markup: {
                keyboard: [
                    [{ text: '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å' }]
                ],
                resize_keyboard: true
            }
        }
    );
});

bot.hears('‚ùì –ü–æ–º–æ—â—å', async (ctx) => {
    await ctx.reply(
        `üìñ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:\n\n` +
        `1. –ù–∞–∂–º–∏ /practice –∏–ª–∏ –∫–Ω–æ–ø–∫—É "üß† –ü—Ä–∞–∫—Ç–∏–∫–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏"\n` +
        `2. –û–ø–∏—à–∏ —á—Ç–æ-—Ç–æ —Ö–æ—Ä–æ—à–µ–µ, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–µ–≥–æ–¥–Ω—è\n` +
        `3. –ü–æ–ª—É—á–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –∏–Ω—Å–∞–π—Ç –æ—Ç AI\n\n` +
        `üí° –≠—Ç–æ –Ω–µ —Ç–µ—Ä–∞–ø–∏—è, –∞ –ø—Ä–∞–∫—Ç–∏–∫–∞ —Ä–∞–∑–≤–∏—Ç–∏—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏.\n` +
        `–î–ª—è —Å–µ—Ä—å—ë–∑–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –æ–±—Ä–∞—Ç–∏—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.\n\n` +
        `üìû –ö—Ä–∏–∑–∏—Å–Ω–∞—è –ø–æ–º–æ—â—å:\n` +
        `–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è: 8-800-2000-122 (24/7, –±–µ—Å–ø–ª–∞—Ç–Ω–æ)`
    );
});

bot.hears('‚ùå –û—Ç–º–µ–Ω–∏—Ç—å', async (ctx) => {
    const userId = ctx.from.id;
    userStates.delete(userId);

    await ctx.reply(
        '–ü—Ä–∞–∫—Ç–∏–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞. –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫–æ–≥–¥–∞ –±—É–¥–µ—à—å –≥–æ—Ç–æ–≤! üòä',
        {
            reply_markup: {
                keyboard: [
                    [{ text: '‚úÖ –ü—Ä–∞–∫—Ç–∏–∫–∞ –û–ö-–Ω–æ—Å—Ç–∏' }],
                    [{ text: '‚ùì –ü–æ–º–æ—â—å' }]
                ],
                resize_keyboard: true
            }
        }
    );
});

// ==================== –û–ë–†–ê–ë–û–¢–ö–ê –¢–ï–ö–°–¢–û–í–´–• –°–û–û–ë–©–ï–ù–ò–ô ====================

bot.on('text', async (ctx) => {
    const userId = ctx.from.id;
    const userState = userStates.get(userId);

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
    if (!userState || userState.state !== 'awaiting_okness') {
        await ctx.reply(
            '–ò—Å–ø–æ–ª—å–∑—É–π /practice —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É –û–ö-–Ω–æ—Å—Ç–∏ ‚ú®'
        );
        return;
    }

    const userText = ctx.message.text;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç
    if (userText.length < 10) {
        await ctx.reply(
            '–ü–æ–ø—Ä–æ–±—É–π –æ–ø–∏—Å–∞—Ç—å —á—É—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ - —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π üòä'
        );
        return;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
    await ctx.sendChatAction('typing');

    try {
        console.log('üéØ –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', ctx.from.username, '| –¢–µ–∫—Å—Ç:', userText.substring(0, 50) + '...');

        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Gemini
        const analysis = await gemini.analyzeOkness(userText);

        console.log('‚úÖ –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—É—á–µ–Ω, –¥–ª–∏–Ω–∞:', analysis ? analysis.length : 0);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π
        if (!analysis || analysis.trim().length === 0) {
            console.warn('‚ö†Ô∏è  Gemini –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
            await ctx.reply(
                'ü§î AI –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Å–∞–π—Ç. –ü–æ–ø—Ä–æ–±—É–π –æ–ø–∏—Å–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É —á—É—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ /practice'
            );
            userStates.delete(userId);
            return;
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await ctx.reply(
            `üßò –¢–≤–æ—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –û–ö-–Ω–æ—Å—Ç–∏:

` +
            `"${userText.length > 200 ? userText.substring(0, 200) + '...' : userText}"

` +
            `ÔøΩ –û—Ç—Ä–∞–∂–µ–Ω–∏–µ:
${analysis}

` +
            `–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ. –ü—Ä—è–º–æ —Å–µ–π—á–∞—Å —Å —Ç–æ–±–æ–π –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ. ‚ú®`,
            {
                reply_markup: {
                    keyboard: [
                        [{ text: '‚úÖ –ü—Ä–∞–∫—Ç–∏–∫–∞ –û–ö-–Ω–æ—Å—Ç–∏' }],
                        [{ text: '‚ùì –ü–æ–º–æ—â—å' }]
                    ],
                    resize_keyboard: true
                }
            }
        );

        // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        userStates.delete(userId);

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏:');
        console.error('–¢–∏–ø:', error.name);
        console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
        console.error('Stack:', error.stack);

        await ctx.reply(
            'üòî –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ /practice',
            {
                reply_markup: {
                    keyboard: [
                        [{ text: '‚úÖ –ü—Ä–∞–∫—Ç–∏–∫–∞ –û–ö-–Ω–æ—Å—Ç–∏' }],
                        [{ text: '‚ùì –ü–æ–º–æ—â—å' }]
                    ],
                    resize_keyboard: true
                }
            }
        );

        userStates.delete(userId);
    }
});

// ==================== –ó–ê–ü–£–°–ö –ë–û–¢–ê ====================

async function startBot() {
    try {
        console.log('üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Gemini...');
        const isHealthy = await gemini.healthCheck();

        if (!isHealthy) {
            console.warn('‚ö†Ô∏è  Gemini API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è');
        } else {
            console.log('‚úÖ Gemini API –ø–æ–¥–∫–ª—é—á–µ–Ω');
        }

        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ
        const botInfo = await bot.telegram.getMe();

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –∑–∞–ø—É—Å–∫–∞
        const PORT = process.env.PORT || 3000;
        const WEBHOOK_DOMAIN = process.env.WEBHOOK_DOMAIN;

        if (WEBHOOK_DOMAIN) {
            // Production —Ä–µ–∂–∏–º —Å webhook (Railway)
            console.log('üåê –ó–∞–ø—É—Å–∫ –≤ webhook —Ä–µ–∂–∏–º–µ');

            const webhookPath = `/webhook/${BOT_TOKEN}`;
            const webhookUrl = `${WEBHOOK_DOMAIN}${webhookPath}`;

            // –°–æ–∑–¥–∞–µ–º Express –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            const app = express();

            // Health check endpoint
            app.get('/', (req, res) => {
                res.json({ status: 'ok', bot: botInfo.username });
            });

            // Webhook endpoint
            app.use(bot.webhookCallback(webhookPath));

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
            const server = app.listen(PORT, async () => {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π webhook
                await bot.telegram.deleteWebhook();

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π webhook
                await bot.telegram.setWebhook(webhookUrl);
                console.log(`üì° Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${webhookUrl}`);

                console.log('‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                console.log(`üì± –ë–æ—Ç: @${botInfo.username}`);
                console.log(`üåç –†–µ–∂–∏–º: webhook`);
                console.log(`üîå –ü–æ—Ä—Ç: ${PORT}`);
                console.log(`üè• Health check: ${WEBHOOK_DOMAIN}/`);
            });

            // Graceful shutdown –¥–ª—è webhook
            process.once('SIGINT', () => {
                console.log('\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...');
                server.close(() => {
                    console.log('–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    process.exit(0);
                });
            });

            process.once('SIGTERM', () => {
                console.log('\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...');
                server.close(() => {
                    console.log('–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    process.exit(0);
                });
            });

        } else {
            // Development —Ä–µ–∂–∏–º —Å long polling (–ª–æ–∫–∞–ª—å–Ω–æ)
            console.log('üíª –ó–∞–ø—É—Å–∫ –≤ polling —Ä–µ–∂–∏–º–µ');

            await bot.launch();

            console.log('‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
            console.log(`üì± –ë–æ—Ç: @${botInfo.username}`);
            console.log(`üåç –†–µ–∂–∏–º: ${process.env.NODE_ENV || 'development'}`);
        }

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:', error);
        process.exit(1);
    }
}

// Graceful shutdown
process.once('SIGINT', () => {
    console.log('\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...');
    bot.stop('SIGINT');
});

process.once('SIGTERM', () => {
    console.log('\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...');
    bot.stop('SIGTERM');
});

// –ó–∞–ø—É—Å–∫
startBot();
